<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Patrick Miller" />

<meta name="date" content="2019-06-19" />

<title>Productionizing with Civis Scripts</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Productionizing with Civis Scripts</h1>
<h4 class="author">Patrick Miller</h4>
<h4 class="date">2019-06-19</h4>



<p>Civis Scripts are the way to productionize your code with Civis Platform. You’ve probably used three of the four types of scripts already in the Civis Platform UI (“Code” –&gt; “Scripts”): <em>language</em> (<a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=r">R</a>, <a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=python">Python3</a>, <a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=javascript">javascript</a>, and <a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=sql">sql</a>), <a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=container"><em>container</em></a>, and <a href="https://platform.civisanalytics.com/spa/#/scripts/new?type=custom&amp;fromTemplateId=11219"><em>custom</em></a>. If you’ve run any of these scripts in Civis Platform, you’ve already started <em>productionizing</em> your code. Most loosely, productionizing means that your code now runs on a remote server than your local or development machine.</p>
<p>You probably already know some of the benefits too:</p>
<ol style="list-style-type: decimal">
<li>Easily schedule and automate tasks, and include tasks in workflows.</li>
<li>Ensure your code doesn’t break in the future when dependencies change.</li>
<li>Share code with others without them worrying about dependencies or language compatibility.</li>
<li>Rapidly deploy fixes and changes.</li>
</ol>
<p>This guide will cover how to programmatically do the same tasks using the API that you are used to doing in GUI. Instead of typing in values for the parameters or clicking to download outputs, you can do the same thing in your programs. Hooray for automation!</p>
<p>Specifically, this guide will cover how to programmatically read outputs, kick off new script runs, and publish your own script templates to share your code with others. It will make heavy use of API functions directly, but highlight convenient wrappers for common tasks where they have been implemented already.</p>
<p>Ready? Buckle in!</p>
<div id="script-concepts-and-overview" class="section level2">
<h2>Script Concepts and Overview</h2>
<p>A script is a job that executes code in Civis Platform. A script accepts user input through <em>parameters</em>, gives values back to the user as <em>run outputs</em>, and records any <em>logs</em> along the way.</p>
<p>A script author can share language and container scripts with others by letting users <em>clone</em> the script. But if an author makes a change to the script such as fixing a bug or adding a feature, users will have to re-clone the script to get access to those changes.</p>
<p>A better way to share code with others is with <em>template</em> scripts. A template script is a ‘published’ language or container script. The script that the template runs is the <em>backing script</em> of the template.</p>
<p>Once a container or language script is published as a template, users can create their own instances of the template. These instances are called <em>custom</em> scripts and they inherit all changes made to the template. This feature makes it easy to share code with others and to rapidly deploy changes and fixes.</p>
</div>
<div id="quick-start" class="section level2">
<h2>Quick Start</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># create a container script with a parameter</span></a>
<a class="sourceLine" id="cb1-2" title="2">script &lt;-<span class="st"> </span><span class="kw">scripts_post_containers</span>(</a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="dt">required_resources =</span> <span class="kw">list</span>(<span class="dt">cpu =</span> <span class="dv">1024</span>, <span class="dt">memory =</span> <span class="dv">50</span>, <span class="dt">diskSpace =</span> <span class="dv">15</span>),</a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="dt">docker_command =</span> <span class="st">&#39;cd /package_dir &amp;&amp; Rscript inst/run_script.R&#39;</span>,</a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="dt">docker_image_name =</span> <span class="st">&#39;civisanalytics/datascience-r&#39;</span>,</a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="dt">name =</span> <span class="st">&#39;SCRIPT NAME&#39;</span>,</a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="dt">params =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="kw">list</span>(<span class="dt">name =</span> <span class="st">&#39;NAME_OF_ENV_VAR&#39;</span>,</a>
<a class="sourceLine" id="cb1-9" title="9">         <span class="dt">label =</span> <span class="st">&#39;Name User Sees&#39;</span>, </a>
<a class="sourceLine" id="cb1-10" title="10">         <span class="dt">type =</span> <span class="st">&#39;string&#39;</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">         <span class="dt">required =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-12" title="12">  )</a>
<a class="sourceLine" id="cb1-13" title="13">)</a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co"># publish the container script as a template </span></a>
<a class="sourceLine" id="cb1-16" title="16">template &lt;-<span class="st"> </span><span class="kw">templates_post_scripts</span>(script<span class="op">$</span>id, <span class="dt">name =</span> <span class="st">&#39;TEMPLATE NAME&#39;</span>, <span class="dt">note =</span> <span class="st">&#39;Markdown Docs&#39;</span>)</a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co"># run a template script, returning file ids of run outputs</span></a>
<a class="sourceLine" id="cb1-19" title="19">out &lt;-<span class="st"> </span><span class="kw">run_template</span>(template<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co"># post a file or JSONValue run output within a script</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="kw">write_job_output</span>(<span class="st">&#39;filename.csv&#39;</span>)</a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">json_values_post</span>(jsonlite<span class="op">::</span><span class="kw">toJSON</span>(my_list), <span class="st">&#39;my_list.json&#39;</span>)</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co"># get run output file ids of a script</span></a>
<a class="sourceLine" id="cb1-26" title="26">out &lt;-<span class="st"> </span><span class="kw">fetch_output_file_ids</span>(<span class="kw">civis_script</span>(id))</a>
<a class="sourceLine" id="cb1-27" title="27"></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="co"># get csv run outputs of a script</span></a>
<a class="sourceLine" id="cb1-29" title="29">df &lt;-<span class="st"> </span><span class="kw">read_civis</span>(<span class="kw">civis_script</span>(id), <span class="dt">regex =</span> <span class="st">&#39;.csv&#39;</span>, <span class="dt">using =</span> read.csv)</a>
<a class="sourceLine" id="cb1-30" title="30"></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="co"># get JSONValue run outputs</span></a>
<a class="sourceLine" id="cb1-32" title="32">my_list &lt;-<span class="st"> </span><span class="kw">read_civis</span>(<span class="kw">civis_script</span>(id))</a></code></pre></div>
</div>
<div id="creating-and-running-scripts" class="section level2">
<h2>Creating and Running Scripts</h2>
<p>Let’s make these concepts concrete with an example! We’ll use the ‘R’ language script throughout, but <code>container</code> scripts work exactly the same way. In the second section, we’ll cover <code>custom</code> and <code>template</code> scripts.</p>
<div id="an-example-script" class="section level3">
<h3>An Example Script</h3>
<p>The <code>post</code> method creates the job and returns a list of metadata about it, including its type.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="st"> print(&quot;Hello World!&quot;)</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4">job &lt;-<span class="st"> </span><span class="kw">scripts_post_r</span>(<span class="dt">name =</span> <span class="st">&#39;Hello!&#39;</span>, <span class="dt">source =</span> source)</a></code></pre></div>
<p>Each script can be uniquely identified by its <em>job id</em>. If you have a job id but don’t know what kind of script it is, you can do <code>jobs_get(id)</code>.</p>
<p>Each script type is associated with its own API endpoints. For instance, to post a job of each script type, you need <code>scripts_post_r</code>, <code>scripts_post_containers</code>, <code>scripts_post_custom</code>, or <code>templates_post_scripts</code>.</p>
<p>This job hasn’t been run yet. To kick off a run do:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">run &lt;-<span class="st"> </span><span class="kw">scripts_post_r_runs</span>(job<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co"># check the status</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">scripts_get_r_runs</span>(job<span class="op">$</span>id, run<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co"># automatically poll until the job completes</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">await</span>(scripts_get_r_runs, <span class="dt">id =</span> job<span class="op">$</span>id, <span class="dt">run_id =</span> run<span class="op">$</span>id)</a></code></pre></div>
<p>Since kicking off a job and polling until it completes is a really common task for this guide, let’s make it a function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">run_script &lt;-<span class="st"> </span><span class="cf">function</span>(source, <span class="dt">name =</span> <span class="st">&#39;Cool&#39;</span>) {</a>
<a class="sourceLine" id="cb4-2" title="2">  job &lt;-<span class="st"> </span><span class="kw">scripts_post_r</span>(<span class="dt">name =</span> name, <span class="dt">source =</span> source)</a>
<a class="sourceLine" id="cb4-3" title="3">  run &lt;-<span class="st"> </span><span class="kw">scripts_post_r_runs</span>(job<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="kw">await</span>(scripts_get_r_runs, <span class="dt">id =</span> job<span class="op">$</span>id, <span class="dt">run_id =</span> run<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb4-5" title="5">}</a></code></pre></div>
</div>
<div id="run-outputs" class="section level3">
<h3>Run Outputs</h3>
<p>This script isn’t very useful because it doesn’t produce any output that we can access. To add an output to a job, we can use <code>scripts_post_r_runs_outputs</code>. The two most common types of run outputs are <code>Files</code> and <code>JSONValues</code>.</p>
<div id="files" class="section level4">
<h4>Files</h4>
<p>We can specify adding a <code>File</code> as a run output by uploading the object to S3 with <code>write_civis_file</code> and setting <code>object_type</code> in <code>scripts_post_r_runs_outputs</code> to <code>File</code>. Notice that the environment variables <code>CIVIS_JOB_ID</code> and <code>CIVIS_RUN_ID</code> are automatically inserted into the environment for us to have access to.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="st"> library(civis)</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="st"> data(iris)</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="st"> write.csv(iris, &#39;iris.csv&#39;)</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="st"> job_id &lt;- as.numeric(Sys.getenv(&#39;CIVIS_JOB_ID&#39;))</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="st"> run_id &lt;- as.numeric(Sys.getenv(&#39;CIVIS_RUN_ID&#39;))</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="st"> file_id &lt;- write_civis_file(&#39;iris.csv&#39;)</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="st"> scripts_post_r_runs_outputs(job_id, run_id, object_type = &#39;File&#39;, object_id = file_id)</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb5-10" title="10">run &lt;-<span class="st"> </span><span class="kw">run_script</span>(source)</a></code></pre></div>
<p>Since this pattern is so common, we replaced it with the function <code>write_job_output</code> which you can use to post a filename as a run output for any script type.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="st"> library(civis)</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="st"> data(iris)</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="st"> write.csv(iris, &#39;iris.csv&#39;)</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="st"> write_job_output(&#39;iris.csv&#39;)</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb6-7" title="7">run &lt;-<span class="st"> </span><span class="kw">run_script</span>(source)</a></code></pre></div>
</div>
<div id="jsonvalues" class="section level4">
<h4>JSONValues</h4>
<p>It is best practice to make run outputs as portable as possible because the script can be called by any language. For arbitrary data, JSONValues are often the best choice. Regardless, it is user friendly to add the file extension to the name of the run output.</p>
<p>Adding JSONValue run outputs is common enough for it to be implemented directly as a Civis API endpoint, <code>json_values_post</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="st"> library(civis)</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="st"> library(jsonlite)</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="st"> my_farm &lt;- list(cows = 1, ducks = list(mallard = 2, goldeneye = 1))</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="st"> json_values_post(jsonlite::toJSON(my_farm), name = &#39;my_farm.json&#39;)</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb7-7" title="7">run_farm &lt;-<span class="st"> </span><span class="kw">run_script</span>(source)</a></code></pre></div>
<p>To retrieve script outputs we can use <code>scripts_list_r_runs_outputs</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">out &lt;-<span class="st"> </span><span class="kw">scripts_list_r_runs_outputs</span>(run<span class="op">$</span>rId, run<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb8-2" title="2">iris &lt;-<span class="st"> </span><span class="kw">read_civis</span>(out<span class="op">$</span>objectId, <span class="dt">using =</span> read.csv)</a></code></pre></div>
<p>Since this pattern is also common, you can simply use <code>read_civis</code> directly. This will work for any script type. Use <code>regex</code> and <code>using</code> to filter run outputs by file extension, and provide the appropriate reading function. JSONValues can be read automatically!</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co"># get csv run outputs</span></a>
<a class="sourceLine" id="cb9-2" title="2">iris &lt;-<span class="st"> </span><span class="kw">read_civis</span>(<span class="kw">civis_script</span>(run<span class="op">$</span>rId), <span class="dt">regex =</span> <span class="st">&#39;.csv&#39;</span>, <span class="dt">using =</span> read.csv)</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co"># get JSONValues</span></a>
<a class="sourceLine" id="cb9-5" title="5">my_farm &lt;-<span class="st"> </span><span class="kw">read_civis</span>(<span class="kw">civis_script</span>(run_farm<span class="op">$</span>rId))</a></code></pre></div>
<p>A long round trip, but I’m grateful not to lose track of my farm animals.</p>
</div>
</div>
<div id="script-parameters" class="section level3">
<h3>Script Parameters</h3>
<p>Scripts are more useful if their behavior can be configured by the user. We can do this with script parameters! Script <em>parameters</em> are placeholders for input by the user. Specific values of the parameters input by the user are called <em>arguments</em>. Here, we modify <code>run_script</code> to automatically add a parameter, and simultaneously take a value of that parameter provided by the user. In the script itself, we can access the parameter as an environment variable.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># Add &#39;params&#39; and &#39;arguments&#39; to run_script</span></a>
<a class="sourceLine" id="cb10-2" title="2">run_script &lt;-<span class="st"> </span><span class="cf">function</span>(source, args, <span class="dt">name =</span> <span class="st">&#39;Cool&#39;</span>) {</a>
<a class="sourceLine" id="cb10-3" title="3">  params &lt;-<span class="st"> </span><span class="kw">list</span>(          <span class="co"># params is a list of individual parameters</span></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-5" title="5">      <span class="dt">name =</span> <span class="st">&#39;PET_NAME&#39;</span>,   <span class="co"># name of the environment variable with the user value</span></a>
<a class="sourceLine" id="cb10-6" title="6">      <span class="dt">label =</span> <span class="st">&#39;Pet Name&#39;</span>,  <span class="co"># name displaayed to the user</span></a>
<a class="sourceLine" id="cb10-7" title="7">      <span class="dt">type =</span> <span class="st">&#39;string&#39;</span>,     <span class="co"># type </span></a>
<a class="sourceLine" id="cb10-8" title="8">      <span class="dt">required =</span> <span class="ot">TRUE</span>      <span class="co"># required?</span></a>
<a class="sourceLine" id="cb10-9" title="9">    )</a>
<a class="sourceLine" id="cb10-10" title="10">  )</a>
<a class="sourceLine" id="cb10-11" title="11">  job &lt;-<span class="st"> </span><span class="kw">scripts_post_r</span>(<span class="dt">name =</span> name, </a>
<a class="sourceLine" id="cb10-12" title="12">                        <span class="dt">source =</span> source, </a>
<a class="sourceLine" id="cb10-13" title="13">                        <span class="dt">params =</span> params, </a>
<a class="sourceLine" id="cb10-14" title="14">                        <span class="dt">arguments =</span> args)</a>
<a class="sourceLine" id="cb10-15" title="15">  run &lt;-<span class="st"> </span><span class="kw">scripts_post_r_runs</span>(job<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb10-16" title="16">  <span class="kw">await</span>(scripts_get_r_runs, <span class="dt">id =</span> job<span class="op">$</span>id, <span class="dt">run_id =</span> run<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb10-17" title="17">}</a>
<a class="sourceLine" id="cb10-18" title="18"></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co"># Access the PET_NAME variable</span></a>
<a class="sourceLine" id="cb10-20" title="20">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="st">  library(civis)</span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="st">  pet_name &lt;- Sys.getenv(&quot;PET_NAME&quot;)</span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="st">  msg &lt;- paste0(&quot;Hello&quot;, pet_name, &quot;!&quot;)</span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="st">  print(msg)</span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb10-26" title="26"></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co"># Let&#39;s run it! Here we pass the argument &#39;Fitzgerald&#39; to the </span></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="co"># parameter &#39;PET_NAME&#39; that we created.</span></a>
<a class="sourceLine" id="cb10-29" title="29"><span class="kw">run_script</span>(source, <span class="dt">name =</span> <span class="st">&#39;Pet Greeting&#39;</span>, <span class="dt">args =</span> <span class="kw">list</span>(<span class="dt">PET_NAME =</span> <span class="st">&#39;Fitzgerald&#39;</span>))</a></code></pre></div>
</div>
</div>
<div id="sharing-scripts-with-templates" class="section level2">
<h2>Sharing Scripts with Templates</h2>
<p>Now we have a script. How can we share it with others so that they can use it? The best way to share scripts is with <code>templates</code>. Let’s start by simply posting the script above:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">params &lt;-<span class="st"> </span><span class="kw">list</span>(          </a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="dt">name =</span> <span class="st">&#39;PET_NAME&#39;</span>,   </a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="dt">label =</span> <span class="st">&#39;Pet Name&#39;</span>,  </a>
<a class="sourceLine" id="cb11-5" title="5">    <span class="dt">type =</span> <span class="st">&#39;string&#39;</span>,     </a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="dt">required =</span> <span class="ot">TRUE</span>      </a>
<a class="sourceLine" id="cb11-7" title="7">  )</a>
<a class="sourceLine" id="cb11-8" title="8">)</a>
<a class="sourceLine" id="cb11-9" title="9">job &lt;-<span class="st"> </span><span class="kw">scripts_post_r</span>(<span class="dt">name =</span> <span class="st">&#39;Pet Greeter&#39;</span>, </a>
<a class="sourceLine" id="cb11-10" title="10">                      <span class="dt">source =</span> source, </a>
<a class="sourceLine" id="cb11-11" title="11">                      <span class="dt">params =</span> params)</a></code></pre></div>
<p>To make this job a template use <code>templates_post_scripts</code>. Adding a notes field (markdown format) describing what the script does, what the parameters are, and what outputs it posts is often helpful for users.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">note &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="st"># Pet Greeter</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="st">Greets your pet, given its name! </span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="st"> </span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="st">For your pet to receive the greeting, it must be a Civis Platform</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="st">user with the ability to read.</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="st"> </span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="st">Parameters:</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="st">  * Pet Name: string, Name of pet.</span></a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="st">  </span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="st">Returns:</span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="st">  * Nothing</span></a>
<a class="sourceLine" id="cb12-15" title="15"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb12-16" title="16">template &lt;-<span class="st"> </span><span class="kw">templates_post_scripts</span>(<span class="dt">script_id =</span> job<span class="op">$</span>id, <span class="dt">note =</span> note, <span class="dt">name =</span> <span class="st">&#39;Pet Greeter&#39;</span>)</a></code></pre></div>
<div id="custom-scripts" class="section level3">
<h3>Custom Scripts</h3>
<p><code>scripts_post_custom</code> creates an instance of a template that inherits all changes made to the template. We can now make a simple program to call and run an instance of the template.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">job &lt;-<span class="st"> </span><span class="kw">scripts_post_custom</span>(id, <span class="dt">arguments =</span> arguments, ...)</a>
<a class="sourceLine" id="cb13-2" title="2">run &lt;-<span class="st"> </span><span class="kw">scripts_post_custom_runs</span>(job<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">await</span>(scripts_get_custom_runs, <span class="dt">id =</span> job<span class="op">$</span>id, <span class="dt">run_id =</span> run<span class="op">$</span>id)</a></code></pre></div>
<p>Conveniently, <code>run_template</code> does exactly this and is already provided in <code>civis</code>. It returns the output file ids of the job for you to use later on in your program.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">out &lt;-<span class="st"> </span><span class="kw">run_template</span>(template<span class="op">$</span>id, <span class="dt">arguments =</span> <span class="kw">list</span>(<span class="dt">PET_NAME =</span> <span class="st">&#39;CHARLES&#39;</span>))</a></code></pre></div>
<p>To stay organized, let’s automatically add the script to an existing project:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># We might need to find the project id first</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">search_list</span>(<span class="dt">type =</span> <span class="st">&#39;project&#39;</span>, <span class="st">&#39;My project Name&#39;</span>)</a>
<a class="sourceLine" id="cb15-3" title="3">out &lt;-<span class="st"> </span><span class="kw">run_template</span>(template<span class="op">$</span>id, <span class="dt">arguments =</span> <span class="kw">list</span>(<span class="dt">PET_NAME =</span> <span class="st">&#39;CHARLES&#39;</span>),</a>
<a class="sourceLine" id="cb15-4" title="4">                    <span class="dt">target_project_id =</span> project_id)</a></code></pre></div>
</div>
<div id="making-changes" class="section level3">
<h3>Making Changes</h3>
<p>To make changes to the template note or name, use <code>templates_patch_scripts</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">templates_patch_scripts</span>(template_id<span class="op">$</span>id, <span class="dt">note =</span> new_note)</a></code></pre></div>
<p>To change the behavior, name, or parameters of the script, update the backing script using <code>scripts_patch_r</code>.</p>
<ul>
<li>Note: It is <em>not recommended</em> to make breaking changes to the API of a script by adding a required parameter, changing a parameter default, or removing a run output. This will break workflows of your users. Instead of making breaking changes, release a new version of the script.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">source &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">  library(civis)</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">  pet_name &lt;- Sys.getenv(&quot;PET_NAME&quot;)</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  msg &lt;- paste0(&quot;Hello &quot;, pet_name, &quot;! Would you care for a sandwich?&quot;)</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  print(msg)</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb17-7" title="7"><span class="kw">scripts_patch_r</span>(<span class="dt">id =</span> job<span class="op">$</span>id, <span class="dt">name =</span> <span class="st">&#39;Pet Greeter&#39;</span>,</a>
<a class="sourceLine" id="cb17-8" title="8">                <span class="dt">source =</span> source,</a>
<a class="sourceLine" id="cb17-9" title="9">                <span class="dt">params =</span> params)</a></code></pre></div>
</div>
<div id="discoverability" class="section level3">
<h3>Discoverability</h3>
<p>To help share your template with others, use this link: <code>https://platform.civisanalytics.com/spa/#/scripts/new/{your template id}</code>.</p>
<p>This link will automatically direct the user to a new instance of the template.</p>
<p>It’s a good idea to archive unused templates so that it’s easy for users to find the right template quickly. This is important if you automatically deploy your templates.</p>
<p>Let’s clean up our experiment by archiving our Pet Greeter Template:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">templates_patch_scripts</span>(template<span class="op">$</span>id, <span class="dt">archived =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>That’s it! Now go forth and productionize!</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
